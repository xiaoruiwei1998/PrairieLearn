<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head', {pageTitle: 'cheat_detection'}); %>
    <script src="<%= node_modules_asset_path('lodash/lodash.min.js') %>"></script>
    <script src="<%= node_modules_asset_path('d3/dist/d3.min.js') %>"></script>
    <script src="<%= asset_path('localscripts/histogram.js') %>"></script>
    <script src="<%= asset_path('localscripts/scatter.js') %>"></script>
    <script src="<%= asset_path('localscripts/parallel_histograms.js') %>"></script>
    <!-- Load Chart.js Library-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
    <!-- Load Papa Parse Library-->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  </head>

  <body>
    <script>
      $(function () {
          $('[data-toggle="popover"]').popover({sanitize: false})
      });
    </script>
    <%- include('../partials/navbar'); %>
    <div id="content" class="container-fluid">
      <%- include('../partials/assessmentSyncErrorsAndWarnings'); %>

      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          Overall Similarity
        </div>
        <% if (assessment_stat.number > 0) { %>
        <div class="card-body">
          <!-- Cheat Detection Overall Sim Chart-->
          <div class="cd_chart" style="position: relative; height: 30vh; width: 60vw">
            <canvas id="chart"></canvas>
            <script>
              graphIt();

              async function graphIt() {
                await getCsvData();
                const ctx = document.getElementById('chart');
                const myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                        datasets: [{
                            label: 'Overall Similarities',
                            data: [12, 19, 3, 5, 2, 3],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 206, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)',
                                'rgba(255, 159, 64, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            async function getCsvData() {
              const overall_data = [];
              const ys = [];

              const csv = await fetch('pages/instructorAssessmentCheatDetection/cheat-detection-py/result.csv');
              const data = await csv.text();
              //Parsing
              Papa.parse(data, {
                header: true,
                skipEmptyLines: true,
                //dynamicTyping: true,
                complete : function(results) {
                  console.log(results);
                  for (i = 0; i < results.data.length; i++) {
                    overall_data.push(results.data[i].overall_prob);
                  }
                  console.log(overall_data);
                }
              });
              //return { xs, ys };
            }
            </script>
          </div>

          <!-- Old Histogram 
          <div id="scoreHist" class="scoreHistogram"></div>
          <script>
            $(function() {
                var data = [<%= assessment_stat.score_hist %>];
                var xgrid = _.range(0, 110, 10);
                var options = {
                    ymin: 0,
                    xlabel: 'score / %',
                    ylabel: 'number of students',
                };
                histogram("#scoreHist", data, xgrid, options);
            });
          </script>
        </div> -->

        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <tbody>
              <tr><td>Number of students</td><td><%= assessment_stat.number %></td></tr>
              <tr><td>Mean score</td><td><%= Math.round(assessment_stat.mean) %>%</td></tr>
              <tr><td>Standard deviation</td><td><%= Math.round(assessment_stat.std) %>%</td></tr>
              <tr><td>Median score</td><td><%= Math.round(assessment_stat.median) %>%</td></tr>
              <tr><td>Minimum score</td><td><%= Math.round(assessment_stat.min) %>%</td></tr>
              <tr><td>Maximum score</td><td><%= Math.round(assessment_stat.max) %>%</td></tr>
              <tr><td>Number of 0%</td><td><%= assessment_stat.n_zero %> (<%= Math.round(assessment_stat.n_zero_perc) %>% of class)</td></tr>
              <tr><td>Number of 100%</td><td><%= assessment_stat.n_hundred %> (<%= Math.round(assessment_stat.n_hundred_perc) %>% of class)</td></tr>
            </tbody>
          </table>
        </div>

        <% } else { %>

        <div class="card-body">
          No student data.
        </div>

        <% }%>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          Time Similarity
        </div>

        <% if (assessment_stat.number > 0) { %>
        <div class="card-body">
          <div id="durationHist" class="histogram"></div>
          <script>
            $(function() {
                var data = [<%= duration_stat.hist %>];
                var xgrid = [<%= duration_stat.threshold_seconds %>];
                var options = {
                    ymin: 0,
                    xlabel: 'duration',
                    ylabel: 'number of students',
                    xTickLabels: [<% duration_stat.threshold_labels.forEach(function(label) { %>'<%= label %>',<% }); %>],
                };
                histogram("#durationHist", data, xgrid, options);
            });
          </script>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <tbody>
              <tr><td>Mean duration</td><td><%= duration_stat.mean %></td></tr>
              <tr><td>Median duration</td><td><%= duration_stat.median %></td></tr>
              <tr><td>Minimum duration</td><td><%= duration_stat.min %></td></tr>
              <tr><td>Maximum duration</td><td><%= duration_stat.max %></td></tr>
            </tbody>
          </table>
        </div>

        <% } else { %>

        <div class="card-body">
          No student data.
        </div>

        <% }%>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          Answer Similarity
        </div>

        <% if (assessment_stat.number > 0) { %>
        <div class="card-body">
          <div id="durationScoreScatter" class="scatter"></div>
          <script>
            $(function() {
                var xdata = [<% user_scores.forEach(function(user) { %><%= user.duration_secs %>,<% }); %>];
                var ydata = [<% user_scores.forEach(function(user) { %><%= user.score_perc %>,<% }); %>];
                var options = {
                    xgrid: [<%= duration_stat.threshold_seconds %>],
                    ygrid: _.range(0, 110, 10),
                    xlabel: 'duration',
                    ylabel: 'score / %',
                    xTickLabels: [<% duration_stat.threshold_labels.forEach(function(label) { %>'<%= label %>',<% }); %>],
                };
                scatter("#durationScoreScatter", xdata, ydata, options);
            });
          </script>
        </div>

        <div class="card-footer">
          <small>
            Each point is one student assessment. Points beyond the plot range are plotted on the edge.
          </small>
        </div>

        <% } else { %>

        <div class="card-body">
          No student data.
        </div>

        <% }%>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          Order Similarity
        </div>

        <% if (assessment_stat.number > 0) { %>
        <div class="card-body">
          <div id="scoreHistsByDateDiv" style="overflow-x: scroll; overflow-y: hidden;"></div>
          <script>
            $(function() {
                var data = [<% assessment_score_histogram_by_date.forEach(function(day) {
                  %>{label: '<%= day.date_formatted %>',
                     mean: '<%= day.mean_score_perc %>',
                     histogram: "<%= day.histogram %>".split(",")},<% }); %>];

                var options = {
                    ygrid: _.range(0, 110, 10),
                    xgrid: [<%= assessment_score_histogram_by_date.length %>],
                    xlabel: 'start date',
                    ylabel: 'score / %',
                    yTickLabels: _.range(100, -10, -10),
                    width: data.length * 200
                };
                parallel_histograms("#scoreHistsByDateDiv", data, options);
            });
          </script>
        </div>

        <% } else { %>

        <div class="card-body">
          No student data.
        </div>

        <% }%>
      </div>

      <div class="card-footer">
        <small>
          Download <a href="<%= urlPrefix %>/assessment/<%= assessment.id %>/assessment_statistics/<%= cheatDetectionCsvFilename %>"><%= cheatDetectionCsvFilename %></a>.
        </small>
      </div>


    </div>
  </body>
</html>
